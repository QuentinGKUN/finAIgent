# 财务分析助手使用说明

## 功能概述

本系统是一个智能财务分析助手，支持美股和A股公司的财务数据分析。系统能够：

1. **自动识别公司名称**：从用户问题中提取公司名称或股票代码
2. **智能数据路由**：根据问题类型自动选择合适的数据源
3. **多数据源支持**：支持SEC API（美股）和本地数据/Tushare API（A股）
4. **多轮对话**：支持基于历史对话的上下文理解
5. **数据引用**：所有答案都包含数据来源说明

## 支持的查询类型

### 1. 公司财务指标查询
- **示例**：
  - "Tesla过去三年的营收情况如何？"
  - "宁德时代的研发投入占比是多少？"
  - "300750.SZ的毛利率趋势如何？"

### 2. 年报内容查询（仅美股）
- **示例**：
  - "Tesla的主要业务风险是什么？"
  - "Google在年报中提到了哪些风险因素？"

### 3. 财务趋势分析
- **示例**：
  - "Google过去三年的收入同比（YoY）如何？并给出三年CAGR。"
  - "贵州茅台近三年的净利润增长率是多少？"

### 4. 综合财务分析
- **示例**：
  - "结合年报提到的风险，分析Tesla过去三年的研发投入占比是否有效？"
  - "分析宁德时代的盈利能力变化趋势"

## 数据源配置

### 美股数据源
- **年报文档**：自动从SEC EDGAR获取最新10-K/20-F报告
- **财务数据**：从SEC Company Facts API获取XBRL数据
- **无需配置**：系统自动使用SEC公开API

### A股数据源

#### 方式1：本地JSON文件（推荐）
1. 准备公司列表文件：`data/cn_stocks.json`
2. 准备财务数据文件：`data/cn_finance_data.json`
3. 系统会自动使用本地数据

#### 方式2：Tushare API（可选）
1. 注册Tushare账号并获取token
2. 在`.env`文件中设置：`TUSHARE_TOKEN=your_token`
3. 系统会优先使用本地数据，本地没有时自动调用API

## 数据文件格式

### cn_stocks.json
```json
{
  "stocks": [
    {
      "code": "300750.SZ",
      "name": "宁德时代",
      "market": "SZ"
    }
  ]
}
```

### cn_finance_data.json
```json
{
  "300750.SZ": {
    "name": "宁德时代",
    "data": [
      {
        "year": 2023,
        "revenue": 400917000000,
        "gross_profit": 100000000000,
        "operating_income": 44121000000,
        "net_income": 44121000000,
        "rd": 18356000000,
        "unit": "CNY"
      }
    ]
  }
}
```

## 支持的财务指标

- **Revenue**：营业收入
- **GrossProfit**：毛利润
- **GrossMargin**：毛利率（自动计算）
- **OperatingIncome**：营业利润
- **NetIncome**：净利润
- **RAndD**：研发费用
- **RAndDRatio**：研发费用占比（自动计算）
- **RevenueYoY**：营收同比增长率（自动计算）
- **RevenueCAGR3Y**：三年复合增长率（自动计算）

## 使用示例

### 示例1：查询美股公司财务数据
**用户**：Tesla过去三年的营收情况如何？

**系统处理流程**：
1. 识别公司名称：Tesla
2. 解析为公司代码：通过SEC API获取CIK
3. 获取财务数据：从SEC Company Facts API获取营收数据
4. 生成回答：包含数据引用[F1]

### 示例2：查询A股公司财务数据
**用户**：宁德时代过去三年的营收情况如何？

**系统处理流程**：
1. 识别公司名称：宁德时代
2. 解析为公司代码：从本地JSON或Tushare API获取300750.SZ
3. 获取财务数据：从本地JSON或Tushare API获取营收数据
4. 生成回答：包含数据引用[F1]

### 示例3：多轮对话
**用户**：Tesla的主要业务风险是什么？
**系统**：[回答包含年报片段引用]

**用户**：那这些风险对公司的财务表现有什么影响？
**系统**：[基于之前的对话上下文，结合财务数据分析风险影响]

## 注意事项

1. **A股年报支持**：目前A股年报检索功能暂未实现，主要支持财务数据查询。如需年报功能，可以集成巨潮资讯等数据源。

2. **数据更新**：本地JSON文件需要定期更新以获取最新数据。建议：
   - 使用Tushare API自动获取最新数据
   - 或定期从公开数据源下载更新

3. **API限制**：
   - SEC API：需要设置正确的User-Agent
   - Tushare API：需要注册账号并获取token，有调用频率限制

4. **数据准确性**：系统会尽量使用权威数据源，但建议对重要数据做二次验证。

## 故障排查

### 问题1：无法识别A股公司
- 检查`data/cn_stocks.json`文件是否存在且格式正确
- 确认公司名称或股票代码是否正确

### 问题2：无法获取A股财务数据
- 检查`data/cn_finance_data.json`文件是否存在且包含该公司数据
- 如果使用Tushare API，检查token是否正确设置

### 问题3：美股数据获取失败
- 检查网络连接是否正常
- 确认`.env`文件中的`SEC_USER_AGENT`已正确设置
- 检查Go服务是否正常运行
